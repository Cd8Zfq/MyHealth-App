{% extends "base.html" %}

{% block title %}Historique Patient{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6 space-y-8">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.patients') }}" class="p-2 rounded-xl bg-white border border-gray-200 text-gray-500 hover:text-gray-900 hover:bg-gray-50 transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <div>
                <h2 class="text-2xl font-extrabold text-gray-900">Historique de {{ patient.first_name }} {{ patient.last_name }}</h2>
                <p class="text-sm font-bold text-gray-400">{{ patient.user.email }}</p>
            </div>
        </div>
    </div>

    <!-- GRAPH OVERVIEW -->
    {% if measurements %}
    <div class="bg-white p-6 rounded-[2rem] shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-gray-100">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wide">Évolution</h3>
            
            <!-- Filter Buttons -->
            <div class="flex bg-gray-50 rounded-xl p-1 gap-1 overflow-x-auto max-w-[200px] md:max-w-none no-scrollbar">
                <button onclick="updateChart('all')" id="btn-all" class="px-3 py-1 text-xs font-bold rounded-lg bg-white text-gray-900 shadow-sm transition-all filter-btn whitespace-nowrap">Tous</button>
                <button onclick="updateChart('tension')" id="btn-tension" class="px-3 py-1 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-900 transition-all filter-btn whitespace-nowrap">Tension</button>
                <button onclick="updateChart('glycemie')" id="btn-glycemie" class="px-3 py-1 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-900 transition-all filter-btn whitespace-nowrap">Glycémie</button>
                <button onclick="updateChart('poids')" id="btn-poids" class="px-3 py-1 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-900 transition-all filter-btn whitespace-nowrap">Poids</button>
            </div>
        </div>
        <div class="h-64 w-full">
            <canvas id="patientChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- LIST -->
    <div class="grid gap-3">
        {% for m in measurements %}
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center transition hover:shadow-md hover:border-blue-50">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0
                    {% if m.type == 'tension' %}bg-red-50 text-red-500
                    {% elif m.type == 'glycemie' %}bg-blue-50 text-blue-500
                    {% elif m.type == 'poids' %}bg-green-50 text-green-500
                    {% else %}bg-gray-50 text-gray-500{% endif %}">
                    {% if m.type == 'tension' %}<i data-lucide="heart" class="w-6 h-6"></i>
                    {% elif m.type == 'glycemie' %}<i data-lucide="candy" class="w-6 h-6"></i>
                    {% elif m.type == 'poids' %}<i data-lucide="scale" class="w-6 h-6"></i>
                    {% endif %}
                </div>
                <div>
                    <span class="font-extrabold text-gray-900 text-lg block">{{ m.value1 }}{% if m.value2 %}<span class="text-sm text-gray-400 font-bold">/{{ m.value2 }}</span>{% endif %}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-400">{{ m.unit }}</span>
                        <span class="text-xs font-bold text-gray-300">•</span>
                        <p class="text-xs font-bold text-gray-400">{{ m.date.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                </div>
            </div>
            
            <span class="text-xs font-bold uppercase tracking-wide px-3 py-1 rounded-full
                {% if m.type == 'tension' %}bg-red-50 text-red-600
                {% elif m.type == 'glycemie' %}bg-blue-50 text-blue-600
                {% elif m.type == 'poids' %}bg-green-50 text-green-600
                {% else %}bg-gray-50 text-gray-600{% endif %}">
                {{ m.type }}
            </span>
        </div>
        {% endfor %}
    </div>
</div>

{% if measurements %}
<script>
    let patientChart;
    let rawData = [];

    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('patientChart').getContext('2d');
        rawData = JSON.parse('{{ chart_data_json|safe }}');
        
        initChart(ctx);
        updateChart('all');
    });

    function initChart(ctx) {
        patientChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        padding: 12,
                        cornerRadius: 12,
                        titleFont: { family: 'Nunito', size: 12 },
                        bodyFont: { family: 'Nunito', size: 14, weight: 'bold' },
                        displayColors: true,
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10, family: 'Nunito', weight: 'bold' }, color: '#9CA3AF', maxTicksLimit: 6 } },
                    y: { grid: { color: '#F3F4F6', borderDash: [5, 5] }, ticks: { font: { size: 10, family: 'Nunito', weight: 'bold' }, color: '#9CA3AF', padding: 10 }, beginAtZero: false }
                },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    let currentFilteredData = null;

    function updateChart(type) {
        patientChart.data.datasets = [];
        
        if (type === 'all') {
            currentFilteredData = null;
            patientChart.data.labels = rawData.map(d => d.date);

            patientChart.data.datasets.push({
                label: 'Tension',
                data: rawData.map(d => d.type === 'tension' ? d.val1 : null),
                borderColor: '#EF4444', backgroundColor: '#EF4444', borderWidth: 2, pointRadius: 3, spanGaps: true, tension: 0.4
            });
            patientChart.data.datasets.push({
                label: 'Glycémie',
                data: rawData.map(d => d.type === 'glycemie' ? d.val1 : null),
                borderColor: '#2563EB', backgroundColor: '#2563EB', borderWidth: 2, pointRadius: 3, spanGaps: true, tension: 0.4
            });
            patientChart.data.datasets.push({
                label: 'Poids',
                data: rawData.map(d => d.type === 'poids' ? d.val1 : null),
                borderColor: '#22C55E', backgroundColor: '#22C55E', borderWidth: 2, pointRadius: 3, spanGaps: true, tension: 0.4
            });

        } else {
            const filteredData = rawData.filter(item => item.type === type);
            currentFilteredData = filteredData;
            patientChart.data.labels = filteredData.map(d => d.date);
            
            let color = '#2563EB';
            if (type === 'tension') color = '#EF4444';
            if (type === 'glycemie') color = '#2563EB';
            if (type === 'poids') color = '#22C55E';

            patientChart.data.datasets.push({
                label: type,
                data: filteredData.map(d => d.val1),
                borderColor: color,
                backgroundColor: color + '10',
                pointBorderColor: color,
                borderWidth: 3,
                pointRadius: 4,
                fill: true,
                tension: 0.4
            });
        }
        patientChart.update();

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.getElementById('btn-' + type);
        if(activeBtn) {
            activeBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            activeBtn.classList.remove('text-gray-500');
        }
    }
</script>
{% endif %}
{% endblock %}
